name: Enable auto-merge and sync PR

on:
  pull_request:
    types: [opened, reopened, synchronize, ready_for_review]
  # æ‰¿èªã‚’æ¤œçŸ¥â†’ãƒãƒ¼ã‚¸â†’åŒæœŸPRä½œæˆã®ãƒˆãƒªã‚¬
  pull_request_review:
    types: [submitted]

jobs:
  merge_and_sync:
    # PR ãŒ draft ã§ãªã„å ´åˆã®ã¿å®Ÿè¡Œ
    if: ${{ github.event.pull_request.draft == false }}
    runs-on: ${{ vars.SELF_HOSTED_RUNNER == 'true' && 'arc-runner-set' || 'ubuntu-latest' }}
    permissions:
      pull-requests: write
      contents: write
      actions: write
    env:
      PR_NUMBER: ${{ github.event.pull_request.number }}
      GH_TOKEN: ${{ secrets.BOT_PAT }}
      SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
      DRY_RUN: ${{ vars.FEATURE_UPDATE_DRY_RUN || 'true' }}
    steps:
      - uses: actions/checkout@v4
      - name: Setup gh
        uses: wusatosi/setup-gh@v1
      # ä¸Šæµã‹ã‚‰ä¸‹æµãƒ–ãƒ©ãƒ³ãƒã¸ã®PRã¯è‡ªå‹•æ‰¿èª (mainâ†’developã€developâ†’feature/*)
      - name: Auto-approve upstreamâ†’downstream PR
        if: ${{ (github.event.pull_request.head.ref == 'main' && github.event.pull_request.base.ref == 'develop') || (github.event.pull_request.head.ref == 'develop' && startsWith(github.event.pull_request.base.ref, 'feature/')) }}
        uses: hmarr/auto-approve-action@v4
      # æ‰¿èªæ¸ˆã¿ã‹ã¤ã‚³ãƒ³ãƒ•ãƒªã‚¯ãƒˆãŒç„¡ãã€å¿…é ˆãƒã‚§ãƒƒã‚¯æˆåŠŸãªã‚‰ãƒãƒ¼ã‚¸
      - name: Conditionally merge PR
        id: merge
        env:
          BASE_BRANCH: ${{ github.event.pull_request.base.ref }}
          HEAD_BRANCH: ${{ github.event.pull_request.head.ref }}
        run: |
          set -euo pipefail
          pr="$PR_NUMBER"
          # ãƒ¬ãƒ“ãƒ¥ãƒ¼çŠ¶æ…‹ã‚’å–å¾—
          state=$(gh pr view "$pr" --repo "$GITHUB_REPOSITORY" --json reviewDecision --jq '.reviewDecision' || echo "UNKNOWN")
          echo "Current review decision: $state"
          if [[ "$state" != "APPROVED" ]]; then
            echo "PR is not yet approved. Skipping merge."
            echo "merged=false" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          # ã‚³ãƒ³ãƒ•ãƒªã‚¯ãƒˆæœ‰ç„¡ã‚’ç¢ºèª
          mergeable=$(gh pr view "$pr" --repo "$GITHUB_REPOSITORY" --json mergeable --jq '.mergeable' || echo "UNKNOWN")
          echo "Mergeability: $mergeable"
          if [[ "$mergeable" == "CONFLICTING" || "$mergeable" == "UNKNOWN" ]]; then
            # ã‚³ãƒ³ãƒ•ãƒªã‚¯ãƒˆãŒã‚ã‚‹å ´åˆã¯ Slack ã«é€šçŸ¥ã—ã€ãƒãƒ¼ã‚¸ã‚’ã‚¹ã‚­ãƒƒãƒ—
            # PR ã® URL ã‚’å–å¾—ã—ã€Slack ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã«å«ã‚ã‚‹
            pr_url=$(gh pr view "$pr" --repo "$GITHUB_REPOSITORY" --json url --jq '.url' || echo "")
            slack_text=""
            if [[ "$DRY_RUN" == "true" ]]; then
              slack_text="ğŸ” *(dry-run)* PR has merge conflicts and cannot be merged automatically\n"
            else
              slack_text="âš ï¸ PR has merge conflicts and cannot be merged automatically\n"
            fi
            # è©³ç´°ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¿½åŠ ï¼ˆãƒ–ãƒ©ãƒ³ãƒåä»˜ãï¼‰
            slack_text+="*${HEAD_BRANCH}* â†’ *${BASE_BRANCH}* ã®ãƒãƒ¼ã‚¸ã«ã‚³ãƒ³ãƒ•ãƒªã‚¯ãƒˆãŒã‚ã‚Šã¾ã™ã€‚\n"
            # PR URL ã‚’ãƒªãƒ³ã‚¯ä»˜ãã§è¿½åŠ ï¼ˆSlack ã®ãƒªãƒ³ã‚¯ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆã‚’ä½¿ç”¨ï¼‰
            if [[ -n "$pr_url" ]]; then
              slack_text+="<${pr_url}|PR #${pr}> ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚"
            fi
            # @here ãƒ¡ãƒ³ã‚·ãƒ§ãƒ³è¿½åŠ  & blocks ã§ç¢ºå®Ÿã«æ”¹è¡Œã‚’åæ˜ 
            slack_text="<!here>\n${slack_text}"
            payload=$(jq -n --arg text "$slack_text" '{text: $text, blocks:[{type:"section",text:{type:"mrkdwn",text:$text}}]}')
            curl -s -X POST -H 'Content-type: application/json' --data "$payload" "$SLACK_WEBHOOK_URL"
            echo "merged=false" >> "$GITHUB_OUTPUT"
            exit 0
          fi
          base_branch="$BASE_BRANCH"
          head_branch="$HEAD_BRANCH"
          echo "Base branch: $base_branch, Head branch: $head_branch"
          # ãƒãƒ¼ã‚¸ã‚’å®Ÿè¡Œ (--repo ã‚’å¿…ãšæŒ‡å®šã™ã‚‹)
          gh pr merge "$pr" --repo "$GITHUB_REPOSITORY" --merge
          echo "merged=true" >> "$GITHUB_OUTPUT"
          echo "base_branch=$base_branch" >> "$GITHUB_OUTPUT"
          echo "head_branch=$head_branch" >> "$GITHUB_OUTPUT"
      # develop ã«ãƒãƒ¼ã‚¸ã•ã‚ŒãŸå ´åˆã«ã®ã¿åŒæœŸPRã‚’ä½œæˆ
      - name: Sync develop into active feature branches
        if: steps.merge.outputs.merged == 'true' && steps.merge.outputs.base_branch == 'develop'
        run: |
          set -euo pipefail
          repo="${{ github.repository }}"
          merged="${{ steps.merge.outputs.head_branch }}"
          cutoff=$(date -u -d '-7 days' +%s)
          summary=''
          echo "Merged branch: $merged"
          # feature/* ãƒ–ãƒ©ãƒ³ãƒã‚’åˆ—æŒ™
          branches=$(gh api "/repos/${repo}/branches?per_page=100" --paginate --jq '.[].name' | grep '^feature/' || true)
          for br in $branches; do
            # ç›´å‰ã«ãƒãƒ¼ã‚¸ã—ãŸãƒ–ãƒ©ãƒ³ãƒã¯ã‚¹ã‚­ãƒƒãƒ—
            if [[ "$br" == "$merged" ]]; then
              echo "ğŸš«  $br was just merged into develop; skip sync PR"
              continue
            fi
            # æœ€çµ‚æ›´æ–°ãŒ7æ—¥ä»¥ä¸Šå‰ã®ãƒ–ãƒ©ãƒ³ãƒã¯ã‚¹ã‚­ãƒƒãƒ—
            pushed=$(gh api "/repos/${repo}/branches/${br}" --jq '.commit.commit.committer.date' || echo '')
            if [[ -n "$pushed" && $(date -d "$pushed" +%s) -lt $cutoff ]]; then
              echo "â­  $br skipped (stale: $pushed)"
              continue
            fi
            echo "ğŸ”  $br is active (last push $pushed)"
            # æ—¢ã«é–‹ã„ã¦ã„ã‚‹ PR ãŒå­˜åœ¨ã™ã‚‹ã‹ç¢ºèª
            existing=$(gh pr list \
                        --repo "${repo}" \
                        --base "$br" \
                        --head develop \
                        --state open \
                        --json url -q '.[0].url' || echo '')
            if [[ -n "$existing" ]]; then
              echo "â†³  PR already exists: $existing (skip)"
              continue
            fi
            if [[ "$DRY_RUN" == "true" ]]; then
              summary+=$'\nâ€¢ (dry-run) develop â†’ '"${br}"
              echo "ğŸ’¡  (dry-run) Would create PR develop â†’ $br"
              continue
            fi
            echo "âœï¸  Creating PR develop â†’ $br ..."
            pr_url=$(gh pr create --repo "${repo}" --base "$br" --head develop \
                        --title "Sync develop into $br" \
                        --body "Automated PR to keep **$br** up-to-date with **develop**." \
                        | tail -n1)
            summary+=$'\nâ€¢ *'"${br}"'* â€” <'"${pr_url}"'|åŒæœŸ PR>'
          done
          # Slack é€šçŸ¥
          # åŒæœŸ PR ä½œæˆæ™‚ç‚¹ã§ã¯é€šçŸ¥ã‚’é€ã‚‰ãªã„ã‚ˆã†ã«ã™ã‚‹
          # å¿…è¦ã«å¿œã˜ã¦ summary ã‚’ãƒ­ã‚°å‡ºåŠ›
          echo "Sync PR summary: $summary"
      - name: Notify merge into main or feature branch
        if: steps.merge.outputs.merged == 'true' && (steps.merge.outputs.base_branch == 'main' || startsWith(steps.merge.outputs.base_branch, 'feature/'))
        env:
          BASE_BRANCH: ${{ steps.merge.outputs.base_branch }}
          HEAD_BRANCH: ${{ steps.merge.outputs.head_branch }}
        run: |
          set -euo pipefail
          base="$BASE_BRANCH"
          head="$HEAD_BRANCH"
          slack_text=""
          # PR ã® URL ã‚’å–å¾—
          pr_url=$(gh pr view "$PR_NUMBER" --repo "$GITHUB_REPOSITORY" --json url --jq '.url' || echo "")
          # main ã«ãƒãƒ¼ã‚¸ã•ã‚ŒãŸå ´åˆã¯ headâ†’main ã®é€šçŸ¥
          if [[ "$base" == "main" ]]; then
            if [[ "$DRY_RUN" == "true" ]]; then
              slack_text="ğŸ” *(dry-run)* PR merged into main\n"
            else
              slack_text="ğŸŸ¢ PR merged into main\n"
            fi
            slack_text+="*${head}* â†’ *${base}* ãŒãƒãƒ¼ã‚¸ã•ã‚Œã¾ã—ãŸã€‚"
          # feature/* ã«ãƒãƒ¼ã‚¸ã•ã‚ŒãŸå ´åˆã¯ developâ†’feature/* ã®é€šçŸ¥
          elif [[ "$base" == feature/* ]]; then
            if [[ "$DRY_RUN" == "true" ]]; then
              slack_text="ğŸ” *(dry-run)* PR merged into feature branch\n"
            else
              slack_text="ğŸŸ¢ PR merged into feature branch\n"
            fi
            slack_text+="*${head}* â†’ *${base}* ãŒãƒãƒ¼ã‚¸ã•ã‚Œã¾ã—ãŸã€‚"
          fi
          # PR URL ã‚’è¿½è¨˜
          if [[ -n "$pr_url" ]]; then
            slack_text+="\n<${pr_url}|PR #${PR_NUMBER}>"
          fi
          # é€šçŸ¥ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãŒã‚ã‚Œã°é€ä¿¡
          if [[ -n "$slack_text" ]]; then
            # å…ˆé ­ã« @here
            slack_text="<!here>\n${slack_text}"
            payload=$(jq -n --arg text "$slack_text" '{text: $text, blocks:[{type:"section",text:{type:"mrkdwn",text:$text}}]}')
            curl -s -X POST -H 'Content-type: application/json' --data "$payload" "$SLACK_WEBHOOK_URL"
          fi