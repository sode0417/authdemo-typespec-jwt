# .github/workflows/feature-update-pr.yml
name: "PR: develop â†’ active feature/*"

on:
  # Run only after a PR into develop is closed (merged or just closed)
  pull_request:
    types: [closed]
    branches:
      - develop

concurrency:
  group: feature-update-pr-${{ github.ref }}
  cancel-in-progress: false

jobs:
  create-prs:
    # âœ… ãƒãƒ¼ã‚¸ã•ã‚ŒãŸã¨ãã ã‘å®Ÿè¡Œ
    if: ${{ github.event.pull_request.merged == true }}
    runs-on: ubuntu-latest
    env:
      GH_TOKEN: ${{ secrets.BOT_PAT }}
      SLACK_WEBHOOK_URL:  ${{ secrets.SLACK_WEBHOOK_URL }}
      DRY_RUN: ${{ vars.FEATURE_UPDATE_DRY_RUN || 'true' }}

    steps:
      - uses: actions/checkout@v4

      - name: Scan and open PRs
        run: |
          set -euo pipefail
          repo="${{ github.repository }}"
          cutoff=$(date -u -d '-7 days' +%s)
          dry="${{ github.event.inputs.dry_run || 'false' }}"
          summary=''

          # âœ… ãƒãƒ¼ã‚¸ã•ã‚ŒãŸ feature ãƒ–ãƒ©ãƒ³ãƒåã‚’è‡ªå‹•æ¤œå‡ºï¼ˆæ‰‹å‹•å…¥åŠ›ãŒã‚ã‚Œã°ãã¡ã‚‰ã‚’å„ªå…ˆï¼‰
          merged_input="${{ github.event.inputs.merged_branch }}"
          merged_auto="${{ github.event_name == 'pull_request' && github.event.pull_request.head.ref || '' }}"
          merged="${merged_input:-$merged_auto}"

          if [[ -n "$merged" ]]; then
            summary+=$'\nâ€¢ *'"${merged}"'* â€” develop â† feature ãƒãƒ¼ã‚¸å®Œäº†'
          fi

          echo "==> Collecting feature/* branches updated since $(date -u -d '-7 days')"
          branches=$(gh api "/repos/${repo}/branches?per_page=100" --paginate --jq '.[].name' | grep '^feature/' || true)

          for br in $branches; do
            # ç›´å‰ã« develop ã¸ãƒãƒ¼ã‚¸ã•ã‚ŒãŸãƒ–ãƒ©ãƒ³ãƒã¯ã‚¹ã‚­ãƒƒãƒ—
            if [[ -n "$merged" && "$br" == "$merged" ]]; then
              echo "ğŸš«  $br was just merged into develop; skip sync PR"
              continue
            fi

            # æœ€çµ‚æ›´æ–°ãŒ7æ—¥ä»¥ä¸Šå‰ã®ãƒ–ãƒ©ãƒ³ãƒã¯ã‚¹ã‚­ãƒƒãƒ—
            pushed=$(gh api "/repos/${repo}/branches/${br}" --jq '.commit.commit.committer.date')
            if [[ -z "$pushed" ]]; then
              echo "â­  $br skipped (no commit info)"
              continue
            fi
            if [[ $(date -d "$pushed" +%s) -lt $cutoff ]]; then
              echo "â­  $br skipped (stale: $pushed)"
              continue
            fi

            echo "ğŸ”  $br is active (last push $pushed)"

            # æ—¢ã«é–‹ã„ã¦ã„ã‚‹ PR ãŒå­˜åœ¨ã™ã‚‹ã‹ç¢ºèª
            existing=$(gh pr list \
                        --repo "${repo}" \
                        --base "$br" \
                        --head develop \
                        --state open \
                        --json url -q '.[0].url' || true)
            if [[ -n "$existing" ]]; then
              echo "â†³  PR already exists: $existing (skip)"
              continue
            fi

            if [[ "$dry" == "true" ]]; then
              summary+=$'\nâ€¢ (dry-run) develop â†’ '"${br}"
              echo "ğŸ’¡  (dry-run) Would create PR develop â†’ $br"
              continue
            fi

            echo "âœï¸  Creating PR develop â†’ $br ..."
            pr_url=$(gh pr create --repo "${repo}" --base "$br" --head develop \
                        --title "Sync develop into $br" \
                        --body "Automated PR to keep **$br** up-to-date with **develop**." \
                        | tail -n1)
            summary+=$'\nâ€¢ *'"${br}"'* â€” <'"${pr_url}"'|åŒæœŸ PR>'
          done

          # Slack é€šçŸ¥
          if [[ -n "$summary" ]]; then
            slack_text=$'ğŸŸ¢ *ä»¥ä¸‹ã®featureãƒ–ãƒ©ãƒ³ãƒãŒæ›´æ–°å¯¾è±¡ã§ã™*\n'
            slack_text+=$'å„è‡ªä½œæ¥­ãƒ–ãƒ©ãƒ³ãƒã®æ›´æ–°ã‚’è¡Œã£ã¦ãã ã•ã„ :arrow_down:\n'
            slack_text+="$summary"
            payload=$(jq -n --arg text "$slack_text" '{text: $text}')
            curl -s -X POST -H 'Content-type: application/json' \
               --data "$payload" "$SLACK_WEBHOOK_URL"
          fi

          echo "âœ…  Finished"

      # ===== å¤±æ•—æ™‚å°‚ç”¨ Slack é€šçŸ¥ =====
      - name: Notify failure to Slack
        if: failure()
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
        run: |
          run_url="$GITHUB_SERVER_URL/$GITHUB_REPOSITORY/actions/runs/$GITHUB_RUN_ID"
          text=$'âŒ *feature-update-pr* ã‚¸ãƒ§ãƒ–ãŒå¤±æ•—ã—ã¾ã—ãŸ\n<'$run_url'|ãƒ­ã‚°ã¯ã“ã¡ã‚‰> ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚'
          payload=$(jq -Rn --arg t "$text" '{text:$t}')
          curl -s -X POST -H 'Content-type: application/json' \
               --data "$payload" "$SLACK_WEBHOOK_URL"
