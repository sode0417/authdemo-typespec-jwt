# .github/workflows/feature-update-pr.yml
name: "PR: develop â†’ active feature/*"

on:
  workflow_dispatch:
    inputs:
      dry_run:                         # true ã«ã™ã‚‹ã¨ PR ã‚’ä½œã‚‰ãšãƒ­ã‚°ã ã‘
        description: "Preview only (no PR creation)"
        type: boolean
        default: false

jobs:
  create-prs:
    runs-on: ubuntu-latest
    concurrency:
      group: feature-pr-sync
      cancel-in-progress: false
    permissions: {}              # GITHUB_TOKEN ã‚’ä½¿ã‚ãªã„
    env:
      GH_TOKEN: ${{ secrets.BOT_PAT }}

    steps:
      - uses: actions/checkout@v4
      - name: Scan and open PRs
        run: |
          set -euo pipefail

          repo="${{ github.repository }}"
          cutoff=$(date -u -d '-7 days' +%s)
          dry="${{ github.event.inputs.dry_run || 'false' }}"

          echo "==> Collecting feature/* branches updated since $(date -u -d '-7 days')"
          branches=$(gh api "/repos/${repo}/branches?per_page=100" \
                       --paginate --jq '.[].name' | grep '^feature/')

          for br in $branches; do
            # å–å¾—ã—ãŸãƒ–ãƒ©ãƒ³ãƒã®æœ€æ–° push æ—¥ã‚’ç¢ºèª
            pushed=$(gh api "/repos/${repo}/branches/${br}" --jq '.commit.commit.committer.date')
            pushed_ts=$(date -d "$pushed" +%s)

            if [[ $pushed_ts -lt $cutoff ]]; then
              echo "â­  $br skipped (last push $pushed)"
              continue
            fi

            echo "ğŸ”  $br is active (last push $pushed)"

            # æ—¢å­˜ PR ã®æœ‰ç„¡ã‚’ãƒã‚§ãƒƒã‚¯
            if gh pr list --base "$br" --head develop --json number -q '.[0]'; then
              echo "â†³  PR already exists; skipping"
              continue
            fi

            if [[ $dry == "true" ]]; then
              echo "ğŸ’¡  (dry-run) Would create PR develop â†’ $br"
              continue
            fi

            echo "âœï¸  Creating PR develop â†’ $br ..."
            gh pr create \
              --base "$br" \
              --head develop \
              --title "Sync develop into $br" \
              --body "Automated PR to keep **$br** up-to-date with **develop** (last push: $pushed)."
          done

          echo "âœ…  Finished"
